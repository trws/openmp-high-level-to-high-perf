\subsection{Memory Allocation}
\label{sub:allocators_and_hierarchical_memory}

Memory hierarchies are expected to become deeper in future systems with the
use of technologies such as high-bandwidth memory and non-volatile RAM. Each 
of these technologies has a different programming interface and distinct
performance characteristics. Programming mechanisms must address these 
differences and support intelligent data placement since the fastest resources
typically have limited capacity. To enable programmability of these 
technologies and portability across platforms, OpenMP~5.0 will include a 
consistent and portable interface for placement within the memory hierarchy.

The term \emph{memory space} refers to a memory resource available in the
system when the OpenMP program is executed. Memory spaces differ in their characteristics, for instance in bandwidth or
capacity. OpenMP will define intuitive pre-defined \emph{memory spaces} that map to memory resources found in today's HPC systems.

An \emph{allocator} is an object that is associated to a memory space when created. It allows to allocate and free memory from the resources of its associated memory space. OpenMP will provide a set of pre-defined memory allocators that match its pre-defined memory spaces. For example, the pre-defined memory allocators can select a memory space with large capacity, high bandwidth or low latency, 
or memory local to a particular thread or thread team.


\begin{figure}
\begin{minted}{c}
double *A = (double*) omp_alloc(N,
            omp_high_bw_mem_alloc)
\end{minted}
\caption{High-Bandwidth Memory Allocation\label{fig:allocators}}
\end{figure}

OpenMP 5.0 will include the \texttt{omp\_alloc} and \texttt{omp\_free} 
routines as supersets for \texttt{malloc} and \texttt{free} from 
the standard library. The \texttt{allocate} directive allows to specify the allocation properties of variables that are not allocated through an API call such as global or stack variables. The \texttt{allocate} clause will directly specify 
the use of an allocator for any construct that accepts data sharing clauses.
It enables the allocation of \texttt{private} variables in a particular memory
space. Figure~\ref{fig:allocators} illustrates the use of the pre-defined
\texttt{omp\_high\_bw\_mem\_alloc} allocator to allocate memory from the 
high bandwidth memory space.

In order to support rapid adaption of existing programs to a specific memory 
configuration, the pre-defined allocators are of type \texttt{omp\_allocator\_t *} and they can be treated as regular pointers in the program. Thus, they can be passed by argument and once 
memory allocation uses the OpenMP API function, these code places do not 
have to be modified again just to use a different memory space but just the allocator passed to the function needs to be adjusted.

\begin{figure}[htb]
\begin{minted}[fontsize=\footnotesize]{c}
void some_function ( omp_allocator_t *allocator )
{
   double some_array[N];
#pragma omp parallel private(some_array) \
                     allocate(allocator:some_array)
   {
       ...
   }
}

some_function(omp_high_bw_mem_alloc);
some_function(omp_default_mem_alloc);
\end{minted}
\caption{Separating memory selection from allocation.\label{fig:separation-concerns-alloc}}
\end{figure}

Figure~\ref{fig:separation-concerns-alloc} illustrates how a function can be defined to allow callers to define the memory policy the function should use when allocating the private array \emph{some\_array}.

In addition to pre-defined allocators OpenMP also offers the possibility of creating custom memory allocators where the user can further specify some traits of the allocator that change its behavior. Current traits allow to specify the desired memory alignment, the maximum pool size, the fallback behavior when failing to allocate memory and some hints that allow programmers to specify who will use the allocated memory or expected contention on the allocator.

\begin{figure}[hbt]
\begin{minted}[fontsize=\footnotesize]{c}
omp_alloctraits_t *traits[]=
                 {{OMP_ATK_ALIGNMENT,64},
                  {OMP_ATK_ACCESS,OMP_ATV_THREAD}};
omp_allocator_t *allocator = 
          omp_init_allocator(omp_default_mem_space,
                             2,traits);
\end{minted}
\caption{Creating a custom memory allocator.\label{fig:custom-allocator}}
\end{figure}

Figure~\ref{fig:custom-allocator} shows an example of how a custom allocator can be created in OpenMP~5.0. This particular allocator will return memory from the \emph{default memory space} with 64-byte alignment and the memory will only be accessible by the thread that does the allocations. This allocator can then be used in the previously presented API calls, directives and clauses.
